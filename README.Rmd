---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# caretForecast 

<img src="man/figures/logo.png" align="center" height="139" alt="caretForecast logo" />

<!-- badges: start -->
[![R-CMD-check](https://github.com/taf-society/caretForecast/actions/workflows/R-CMD-check.yaml/badge.svg)](https://github.com/taf-society/caretForecast/actions/workflows/R-CMD-check.yaml)
[![pkgdown](https://github.com/taf-society/caretForecast/actions/workflows/pkgdown.yaml/badge.svg)](https://github.com/taf-society/caretForecast/actions/workflows/pkgdown.yaml)
[![Codecov test coverage](https://codecov.io/gh/taf-society/caretForecast/graph/badge.svg)](https://app.codecov.io/gh/taf-society/caretForecast)
[![CRAN status](https://www.r-pkg.org/badges/version/caretForecast)](https://CRAN.R-project.org/package=caretForecast)
[![CRAN downloads](https://cranlogs.r-pkg.org/badges/grand-total/caretForecast)](https://CRAN.R-project.org/package=caretForecast)
[![Lifecycle: maturing](https://img.shields.io/badge/lifecycle-maturing-blue.svg)](https://lifecycle.r-lib.org/articles/stages.html#maturing)
[![License: GPL v3](https://img.shields.io/badge/License-GPLv3-blue.svg)](https://www.gnu.org/licenses/gpl-3.0)
<!-- badges: end -->


caretForecast aspires to equip users with the means of using machine learning algorithms for time series data forecasting.

## Features

- Use any regression model from the caret package for time series forecasting
- Automatic feature engineering with lagged values and Fourier terms for seasonality
- **Horizon-specific conformal prediction intervals** with proper out-of-sample calibration
- Support for external regressors (promotions, holidays, etc.)
- Compatible with hierarchical/grouped time series via the hts package

## About TAFS

**TAFS (Time Series Analysis and Forecasting Society)** is a non-profit association ("Verein") in Vienna, Austria. It connects academics, experts, practitioners, and students focused on time-series, forecasting, and decision science. Contributions remain fully open source.
Learn more at [taf-society.org](https://taf-society.org/).

## Installation

The CRAN version with:

``` r
install.packages("caretForecast")

```


The development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("taf-society/caretForecast")
```
## Example

By using caretForecast, users can train any regression model that is compatible with the caret package. This allows them to use any machine learning model they need in order to solve specific problems, as shown by the examples below.


### Load the library

```{r example1}
library(caretForecast)

data(retail_wide, package = "caretForecast")

```

### Forecasting with glmboost
```{r, example2}
i <- 8

dtlist <- caretForecast::split_ts(retail_wide[,i], test_size = 12)

training_data <- dtlist$train

testing_data <- dtlist$test

fit <- ARml(training_data, max_lag = 12, caret_method = "cubist", 
            verbose = FALSE)

forecast(fit, h = length(testing_data), level = c(80,95))-> fc

accuracy(fc, testing_data)


autoplot(fc) + 
  autolayer(testing_data, series = "testing_data")

```

### Forecasting with cubist regression

```{r, example3}
i <- 9

dtlist <- caretForecast::split_ts(retail_wide[,i], test_size = 12)

training_data <- dtlist$train

testing_data <- dtlist$test

fit <- ARml(training_data, max_lag = 12, caret_method = "cubist", 
            verbose = FALSE)

forecast(fit, h = length(testing_data), level = c(80,95), PI = TRUE)-> fc

accuracy(fc, testing_data)

autoplot(fc) + 
  autolayer(testing_data, series = "testing_data")

```

### Forecasting using Support Vector Machines with Linear Kernel

```{r, example4}

i <- 9

dtlist <- caretForecast::split_ts(retail_wide[,i], test_size = 12)

training_data <- dtlist$train

testing_data <- dtlist$test

fit <- ARml(training_data, max_lag = 12, caret_method = "svmLinear2", 
            verbose = FALSE, pre_process = c("scale", "center"))

forecast(fit, h = length(testing_data), level = c(80,95), PI = TRUE)-> fc

accuracy(fc, testing_data)

autoplot(fc) + 
  autolayer(testing_data, series = "testing_data")

get_var_imp(fc)

get_var_imp(fc, plot = F)

```

### Forecasting using Ridge Regression

```{r, example5}

i <- 8

dtlist <- caretForecast::split_ts(retail_wide[,i], test_size = 12)

training_data <- dtlist$train

testing_data <- dtlist$test

fit <- ARml(training_data, max_lag = 12, caret_method = "ridge", 
            verbose = FALSE)

forecast(fit, h = length(testing_data), level = c(80,95), PI = TRUE)-> fc

accuracy(fc, testing_data)

autoplot(fc) + 
  autolayer(testing_data, series = "testing_data")

get_var_imp(fc)

get_var_imp(fc, plot = F)
```

## Adding external variables

The xreg argument can be used for adding promotions, holidays, and other external variables to the model. In the example below, we will add seasonal dummies to the model. We set the 'seasonal = FALSE' to avoid adding the Fourier series to the model together with seasonal dummies.

```{r, example6}

xreg_train <- forecast::seasonaldummy(AirPassengers)

newxreg <- forecast::seasonaldummy(AirPassengers, h = 21)

fit <- ARml(AirPassengers, max_lag = 4, caret_method = "cubist", 
            seasonal = FALSE, xreg = xreg_train, verbose = FALSE)

fc <- forecast(fit, h = 12, level = c(80, 95, 99), xreg = newxreg)

autoplot(fc)

get_var_imp(fc)

```

## Conformal Prediction Intervals

As of version 0.1.2, caretForecast implements **horizon-specific conformal prediction intervals**. This approach provides properly calibrated prediction intervals that naturally widen with forecast horizon (trumpet shape), addressing a common limitation of ML-based forecasting methods.

### How it works

When `calibrate = TRUE` (the default), `ARml()` performs rolling-origin calibration using out-of-sample forecasts to compute nonconformity scores for each forecast horizon. This ensures that the prediction intervals have the correct coverage probability.

### Key parameters

- `calibrate`: Logical. If TRUE (default), performs horizon-specific calibration for conformal prediction intervals
- `calibration_horizon`: Maximum forecast horizon for calibration. Defaults to `2 * frequency(y)` for seasonal data or 10 for non-seasonal data
- `n_cal_windows`: Number of rolling windows for calibration. Automatically determined based on data length (max 50)

### Example with calibrated intervals

```{r, example_conformal}
# Fit model with conformal calibration (default)
fit <- ARml(AirPassengers, max_lag = 12, caret_method = "ridge",
            verbose = FALSE, calibrate = TRUE)

# Forecast with prediction intervals
fc <- forecast(fit, h = 24, level = c(80, 95))

# The intervals widen appropriately with forecast horizon
autoplot(fc)
```
